# 下一步开发计划 - 扩张前线

**更新时间**：2024-12-02
**当前状态**：Day 1 核心循环已完成并修复 ✅

---

## 📊 当前完成度

### ✅ 已完成功能（Day 1）
- [x] 游戏数据加载系统（JSON配置化）
- [x] 基础UI框架（5个Tab界面）
- [x] 资源显示和更新
- [x] 建造系统（建筑建造、槽位管理）
- [x] 资源生产系统（矿机采集逻辑）
- [x] 游戏循环（每100ms更新）
- [x] Toast通知系统（成功/错误/警告/信息）
- [x] 自定义确认对话框
- [x] 建筑管理（激活/停用/拆除）
- [x] 未解锁建筑过滤
- [x] 时间系统（昼夜循环）
- [x] 电力系统基础（生产和消耗）
- [x] 调试日志系统

### 🔨 部分完成
- [ ] 科技界面（只有框架，无功能）
- [ ] 仓库界面（只有框架，无功能）
- [ ] 地图界面（只有框架，无功能）
- [ ] 生产建筑（熔炉、组装机定义了但无生产逻辑）
- [ ] 配方系统（数据已定义，但无制造功能）

### ❌ 未实现
- [ ] 科技研究系统
- [ ] 战斗系统
- [ ] 单位（无人机）系统
- [ ] 区域征服机制
- [ ] 配方制造系统
- [ ] 存储上限提示
- [ ] 游戏存档/读档

---

## 🎯 下一步优先级任务

### 🔴 高优先级（核心玩法扩展）

#### 1. 发电站系统（解决电力耗尽问题）
**问题**：当前初始电力500，矿机消耗5/秒，100秒后电力耗尽，矿机停工。

**任务**：
- [ ] 实现燃煤发电站功能（`coal-power`）
  - 消耗煤炭：1 煤/秒
  - 产出电力：20 电力/秒
- [ ] 实现风力发电站功能（`wind-turbine`）
  - 白天 10 电力/秒
  - 夜晚 15 电力/秒
  - 根据 `gameState.time.isDay` 动态调整
- [ ] 添加电力不足警告
  - 当电力 < 50 时显示 Toast 警告
  - 当电力 = 0 时显示红色Toast："电力耗尽！建筑停止工作"

**预期完成时间**：30分钟
**文件修改**：`game.js` (produceResources 函数已有框架)

---

#### 2. 科技研究系统（解锁更多内容）
**问题**：当前只能建造7-8个基础建筑，其他建筑需要科技解锁。

**任务**：
- [ ] 实现科技界面 UI
  - 显示所有可研究的科技
  - 显示科技成本（科研包）
  - 显示前置科技依赖
  - 显示研究进度条
- [ ] 实现研究中心建筑功能
  - 消耗科研包进行研究
  - 研究速度：`researchSpeed` 属性
  - 支持多个研究中心加速
- [ ] 实现科技解锁机制
  - 研究完成后解锁建筑/配方
  - 更新 `gameState.researchedTech` 数组
  - 自动刷新建造界面（新建筑出现）
- [ ] 临时方案：手动生产科研包
  - 在仓库界面添加"生产科研包"按钮
  - 消耗资源换取科研包（用于测试）

**预期完成时间**：1-2小时
**文件修改**：
- `game.js`：科技研究逻辑、UI更新
- `style.css`：科技树样式
- 已有数据：`data/technologies.json`（25个科技）

---

#### 3. 配方制造系统（生产中间产物）
**问题**：当前只有矿机直接产出金属板，无法制造齿轮、电路等中间产物。

**任务**：
- [ ] 实现熔炉功能（`furnace`）
  - 选择配方（如：铁矿石 → 铁板）
  - 消耗输入资源
  - 产出输出资源
  - 支持速度倍率
- [ ] 实现组装机功能（`assembler-mk1/2/3`）
  - 支持复杂配方（多输入 → 单输出）
  - 例如：铁板×2 → 齿轮×1
  - 例如：铁板×1 + 铜线×3 → 电路×1
- [ ] 建筑配方选择界面
  - 点击建筑弹出配方选择对话框
  - 显示可用配方列表
  - 显示配方的输入/输出资源
- [ ] 配方生产逻辑
  - 检查输入资源是否充足
  - 按配方时间生产
  - 产出输出资源

**预期完成时间**：2-3小时
**文件修改**：
- `game.js`：配方生产逻辑
- `style.css`：配方选择对话框样式
- 已有数据：`data/recipes.json`（20+配方）

**依赖**：需要先恢复矿石资源（铁矿石、铜矿石），或者先实现熔炉用其他配方测试。

---

### 🟡 中优先级（游戏体验优化）

#### 4. 资源存储上限提示
**问题**：资源有上限（默认500），满了会浪费生产。

**任务**：
- [ ] 资源接近上限时显示警告
  - 当资源 > max * 0.9 时显示黄色提示
- [ ] 资源达到上限时显示Toast
  - "铁板存储已满！建造仓库扩容"
- [ ] 实现仓库建筑功能
  - 建造仓库增加 `storageBonus`
  - 更新所有资源的 `max` 值

**预期完成时间**：30分钟
**文件修改**：`game.js`

---

#### 5. 区域系统和地图界面
**问题**：当前只有1个区域，无法探索新区域。

**任务**：
- [ ] 实现地图界面 UI
  - 显示所有区域（10个）
  - 显示区域状态（已征服/未征服）
  - 显示区域资源节点
  - 显示区域敌人
- [ ] 区域切换功能
  - 点击已征服的区域切换过去
  - 更新 `gameState.currentRegionId`
  - 刷新区域界面和建造界面
- [ ] 区域征服前置条件（暂不实现战斗）
  - 简化方案：点击按钮直接征服
  - 或者：消耗一定资源解锁新区域

**预期完成时间**：1小时
**文件修改**：`game.js`, `style.css`
**已有数据**：`data/regions.json`（10个区域）

---

#### 6. 战斗系统（Phase 1简化版）
**问题**：当前无法征服有敌人的区域。

**任务（简化版）**：
- [ ] 自动战斗系统
  - 玩家配置编队（选择无人机类型和数量）
  - 点击"进攻"按钮
  - 自动计算战斗结果（基于数值对比）
  - 胜利：征服区域
  - 失败：损失无人机，可重试
- [ ] 无人机生产
  - 兵营建筑生产基础无人机
  - 军工厂生产高级无人机
  - 消耗资源和时间
- [ ] 简化战斗UI
  - 显示敌人列表和总战力
  - 显示我方编队和总战力
  - 战斗日志（文字描述）

**预期完成时间**：2-3小时
**文件修改**：`game.js`, 新增 `combat.js`
**已有数据**：`data/units.json`, `data/enemies.json`

---

### 🟢 低优先级（后续优化）

#### 7. 游戏存档系统
- [ ] 保存游戏状态到 `localStorage`
- [ ] 加载游戏存档
- [ ] 多存档槽位
- [ ] 导出/导入存档（JSON文件）

#### 8. 性能优化
- [ ] 减少DOM更新频率
- [ ] 使用 `requestAnimationFrame` 代替 `setInterval`
- [ ] 虚拟滚动（建筑/资源列表很长时）

#### 9. 移除调试日志
- [ ] 添加 `DEBUG` 开关
- [ ] 生产环境关闭所有 `console.log`
- [ ] 或者改为可选的调试面板

#### 10. 美化和动画
- [ ] 资源数字变化动画
- [ ] 建筑建造动画
- [ ] 科技解锁特效
- [ ] 更好的图标（当前只有文字）

---

## 🐛 已知问题和技术债务

### 问题列表
1. **电力会耗尽**（高优）
   - 当前：初始500电力，矿机消耗5/秒，100秒后耗尽
   - 解决：实现发电站建筑

2. **无法制造中间产物**（高优）
   - 当前：只能采矿，无法冶炼或组装
   - 解决：实现配方制造系统

3. **只有1个区域可用**（中优）
   - 当前：只能在新手区域建造
   - 解决：实现区域系统和简化战斗

4. **调试日志太多**（低优）
   - 当前：控制台每10秒打印一次
   - 解决：添加DEBUG开关或移除

5. **资源存储会满**（中优）
   - 当前：资源上限500，无提示
   - 解决：添加提示和仓库功能

6. **没有存档系统**（低优）
   - 当前：刷新页面数据丢失
   - 解决：使用 localStorage

---

## 📁 项目文件结构

```
expansion/
├── index.html          # 主页面
├── game.js            # 游戏核心逻辑（~800行）
├── style.css          # 样式文件（~550行）
├── data/              # 数据文件（JSON配置）
│   ├── items.json     # 29个物品
│   ├── buildings.json # 26个建筑
│   ├── recipes.json   # 20+配方
│   ├── technologies.json # 25个科技
│   ├── units.json     # 6种无人机
│   ├── enemies.json   # 14种敌人
│   └── regions.json   # 10个区域
├── log/               # 开发日志
│   ├── session_2024-12-02.md
│   ├── BUGFIX2.md
│   ├── BUGFIX3.md
│   └── NEXT_STEPS.md  # 本文件
├── test_mining.html   # 测试页面
└── test_mining.js     # 测试脚本
```

---

## 🔧 技术栈和工具

### 当前技术
- **纯前端**：HTML + CSS + Vanilla JavaScript
- **无框架**：无依赖，原生 DOM 操作
- **数据驱动**：所有游戏数据在 JSON 文件中配置

### 开发工具
```bash
# 启动本地服务器
python3 -m http.server 8000

# 访问游戏
open http://localhost:8000/index.html

# 运行测试脚本
node test_mining.js
```

### 浏览器要求
- 需要支持 ES6+（async/await, 箭头函数等）
- 推荐 Chrome/Firefox 最新版

---

## 💡 开发建议

### 从哪里开始？

#### 如果想快速看到效果（推荐）：
1. **先做发电站**（30分钟）
   - 让游戏可以持续运行
   - 测试电力平衡机制

2. **再做仓库提示**（30分钟）
   - 避免资源浪费
   - 测试存储扩容

3. **然后做科技系统**（2小时）
   - 解锁更多建筑
   - 增加游戏深度

#### 如果想完善核心循环：
1. **恢复矿石→金属板流程**
   - 修改 `regions.json`：资源节点改回 `iron-ore`
   - 实现熔炉配方系统
   - 测试生产链

2. **实现组装机制造齿轮/电路**
   - 齿轮用于建造更多建筑
   - 电路用于高级建筑

3. **添加科技研究**
   - 解锁更多配方和建筑

#### 如果想扩展游戏内容：
1. **实现区域系统**
   - 10个区域可探索
   - 不同资源分布

2. **简化版战斗系统**
   - 自动战斗
   - 征服新区域

---

## 📝 代码注意事项

### 游戏状态管理
```javascript
// 全局状态对象
const gameState = {
    resources: {},           // 所有资源
    regions: [],            // 区域列表
    currentRegionId: 1,     // 当前区域
    researchedTech: [],     // 已研究科技
    time: {},               // 时间系统
    buildingIdCounter: 1    // 建筑ID生成器
};
```

### 重要函数
- `gameLoop(deltaTime)` - 游戏主循环
- `produceResources(deltaTime)` - 资源生产逻辑
- `buildBuilding(buildingId)` - 建造建筑
- `updateResourceDisplay()` - 更新UI显示
- `showToast(message, type)` - 显示通知
- `showConfirm(message)` - 显示确认对话框

### 添加新建筑类别的步骤
1. 在 `buildings.json` 中定义建筑
2. 在 `produceResources()` 中添加该类别的逻辑
3. 在建造界面按类别渲染
4. 测试建造和功能

---

## 🎮 游戏设计目标

### 核心循环（Factorio-like）
```
采矿 → 冶炼 → 制造 → 科技研究 → 解锁新内容 → 扩张到新区域
  ↑                                                    ↓
  └────────────────── 需要更多资源 ←───────────────────┘
```

### 战斗循环（简化版）
```
生产资源 → 制造无人机 → 进攻区域 → 征服 → 获得新资源节点
```

### 最终目标
- Phase 1（5个区域）：基础自动化
- Phase 2（10个区域）：高级自动化 + 化工
- Phase 3（Boss关卡）：核能 + 终极科技

---

## 📞 遇到问题？

### 常见问题自查
1. **刷新后数据丢失**
   - 预期行为，尚未实现存档系统
   - 解决：添加 localStorage

2. **建筑不生产**
   - 检查电力是否充足
   - 检查资源节点是否耗尽
   - 查看浏览器控制台日志

3. **资源不增长**
   - 检查游戏循环是否启动（控制台有心跳日志）
   - 检查建筑是否激活（active: true）
   - 检查是否有匹配的资源节点

4. **建筑无法建造**
   - 检查资源是否充足
   - 检查槽位是否足够
   - 检查是否需要科技（未解锁建筑不显示）

### 调试技巧
```javascript
// 在控制台查看游戏状态
console.log(gameState);

// 查看当前区域
console.log(gameState.regions[0]);

// 查看建筑列表
console.log(gameState.regions[0].buildings);

// 手动增加资源（测试用）
gameState.resources['iron-plate'].current = 1000;

// 手动增加电力
gameState.resources['power'].current = 1000;
```

---

## ✅ 完成标准

每个功能完成后应该：
1. ✅ **功能正常工作**（无报错）
2. ✅ **有用户反馈**（Toast通知或UI更新）
3. ✅ **有调试日志**（方便排查问题）
4. ✅ **更新文档**（在log/中添加实现记录）

---

**祝开发顺利！🚀**

下次继续时，从"🎯 下一步优先级任务"的第一项开始即可。
