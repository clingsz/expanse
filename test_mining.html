<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¿æœºæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background-color: #1a1a1a;
            color: #cccccc;
            padding: 20px;
        }
        #log {
            background-color: #2a2a2a;
            border: 1px solid #00a8ff;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #666;
            padding-left: 10px;
        }
        .log-info { border-left-color: #00a8ff; }
        .log-success { border-left-color: #4caf50; }
        .log-error { border-left-color: #f44336; }
        .log-warning { border-left-color: #ffc107; }
        button {
            background-color: #00a8ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0090dd;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¬ çŸ¿æœºç”Ÿäº§æµ‹è¯•</h1>
    <button onclick="runTest()">è¿è¡Œæµ‹è¯•</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>

    <div id="log"></div>

    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push({ timestamp, message, type });

            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            testLog = [];
            document.getElementById('log').innerHTML = '';
        }

        async function runTest() {
            clearLog();
            log('========================================', 'info');
            log('å¼€å§‹æµ‹è¯•çŸ¿æœºèµ„æºç”Ÿäº§åŠŸèƒ½', 'info');
            log('========================================', 'info');

            try {
                // åŠ è½½æ¸¸æˆæ•°æ®
                log('æ­¥éª¤ 1: åŠ è½½æ¸¸æˆæ•°æ®...', 'info');
                const [items, buildings, regions] = await Promise.all([
                    fetch('data/items.json').then(r => r.json()),
                    fetch('data/buildings.json').then(r => r.json()),
                    fetch('data/regions.json').then(r => r.json())
                ]);

                log(`âœ“ åŠ è½½äº† ${Object.keys(items.items).length} ä¸ªç‰©å“`, 'success');
                log(`âœ“ åŠ è½½äº† ${Object.keys(buildings.buildings).length} ä¸ªå»ºç­‘`, 'success');
                log(`âœ“ åŠ è½½äº† ${regions.regions.length} ä¸ªåŒºåŸŸ`, 'success');

                // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
                log('', 'info');
                log('æ­¥éª¤ 2: åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...', 'info');
                const gameState = {
                    resources: {},
                    time: {
                        isDay: true,
                        totalTime: 0,
                        timeRemaining: 180,
                        dayDuration: 180,
                        nightDuration: 120
                    }
                };

                // åˆå§‹åŒ–èµ„æº
                Object.entries(items.items).forEach(([id, item]) => {
                    gameState.resources[id] = {
                        current: 0,
                        max: item.category === 'energy' ? 1000 : 500
                    };
                });

                // è®¾ç½®åˆå§‹èµ„æº
                gameState.resources['iron-plate'].current = 50;
                gameState.resources['copper-plate'].current = 30;
                gameState.resources['coal'].current = 20;
                gameState.resources['power'].current = 100;

                log(`âœ“ åˆå§‹é“æ¿: ${gameState.resources['iron-plate'].current}`, 'success');
                log(`âœ“ åˆå§‹é“œæ¿: ${gameState.resources['copper-plate'].current}`, 'success');
                log(`âœ“ åˆå§‹ç”µåŠ›: ${gameState.resources['power'].current}`, 'success');

                // åˆ›å»ºæµ‹è¯•åŒºåŸŸ
                const region1Template = regions.regions[0];
                const region = {
                    id: region1Template.id,
                    name: region1Template.name,
                    slotsTotal: region1Template.slotsTotal,
                    slotsUsed: 0,
                    resourceNodes: region1Template.resourceNodes.map(node => ({...node})),
                    buildings: []
                };

                log(`âœ“ åˆ›å»ºåŒºåŸŸ: ${region.name}`, 'success');
                log(`  èµ„æºèŠ‚ç‚¹:`, 'info');
                region.resourceNodes.forEach((node, idx) => {
                    log(`    [${idx}] ${items.items[node.type].name}: ${node.amount} (é€Ÿç‡: ${node.rate}/s)`, 'info');
                });

                // å»ºé€ çŸ¿æœº
                log('', 'info');
                log('æ­¥éª¤ 3: å»ºé€ çŸ¿æœº Mk1...', 'info');
                const minerTemplate = buildings.buildings['miner-mk1'];
                log(`  å»ºç­‘ä¿¡æ¯: ${minerTemplate.name}`, 'info');
                log(`  é€Ÿåº¦å€ç‡: ${minerTemplate.speed}x`, 'info');
                log(`  åŠŸè€—: ${minerTemplate.powerConsumption} ç”µåŠ›/ç§’`, 'info');
                log(`  å…è®¸èµ„æº: ${minerTemplate.allowedResources.join(', ')}`, 'info');

                // é€‰æ‹©èµ„æºèŠ‚ç‚¹
                let selectedNodeIndex = -1;
                for (let i = 0; i < region.resourceNodes.length; i++) {
                    const node = region.resourceNodes[i];
                    if (minerTemplate.allowedResources.includes(node.type)) {
                        selectedNodeIndex = i;
                        log(`âœ“ æ‰¾åˆ°åŒ¹é…çš„èµ„æºèŠ‚ç‚¹ [${i}]: ${items.items[node.type].name}`, 'success');
                        break;
                    }
                }

                if (selectedNodeIndex === -1) {
                    log('âœ— æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èµ„æºèŠ‚ç‚¹ï¼', 'error');
                    log('  çŸ¿æœºå…è®¸çš„èµ„æºç±»å‹:', 'error');
                    minerTemplate.allowedResources.forEach(res => {
                        log(`    - ${res}`, 'error');
                    });
                    log('  åŒºåŸŸçš„èµ„æºèŠ‚ç‚¹ç±»å‹:', 'error');
                    region.resourceNodes.forEach((node, idx) => {
                        log(`    [${idx}] ${node.type}`, 'error');
                    });
                    return;
                }

                // åˆ›å»ºå»ºç­‘
                const building = {
                    id: 1,
                    buildingId: 'miner-mk1',
                    active: true,
                    regionId: region.id,
                    resourceNodeIndex: selectedNodeIndex
                };
                region.buildings.push(building);

                const targetNode = region.resourceNodes[selectedNodeIndex];
                log(`âœ“ çŸ¿æœºå·²å»ºé€ ï¼Œè¿æ¥åˆ°èµ„æºèŠ‚ç‚¹ [${selectedNodeIndex}]`, 'success');
                log(`  ç›®æ ‡èµ„æº: ${items.items[targetNode.type].name}`, 'info');
                log(`  èŠ‚ç‚¹å‰©ä½™: ${targetNode.amount}`, 'info');

                // æ¨¡æ‹Ÿç”Ÿäº§
                log('', 'info');
                log('æ­¥éª¤ 4: æ¨¡æ‹Ÿ 10 ç§’ç”Ÿäº§...', 'info');

                const initialIronPlate = gameState.resources['iron-plate'].current;
                log(`  åˆå§‹é“æ¿æ•°é‡: ${initialIronPlate}`, 'info');

                // æ¨¡æ‹Ÿ 100 æ¬¡å¾ªç¯ï¼Œæ¯æ¬¡ 0.1 ç§’
                for (let i = 0; i < 100; i++) {
                    const deltaTime = 0.1;

                    // ç”Ÿäº§èµ„æº
                    region.buildings.forEach(b => {
                        if (!b.active) return;

                        const template = buildings.buildings[b.buildingId];

                        if (template.category === 'mining' && b.resourceNodeIndex !== undefined) {
                            const hasPower = gameState.resources['power'].current > 0;
                            if (!hasPower && template.powerConsumption) {
                                if (i === 0) log('  âš  ç”µåŠ›ä¸è¶³ï¼ŒçŸ¿æœºåœæ­¢å·¥ä½œ', 'warning');
                                return;
                            }

                            const node = region.resourceNodes[b.resourceNodeIndex];
                            if (node.amount <= 0) {
                                if (i === 0) log('  âš  èµ„æºèŠ‚ç‚¹å·²è€—å°½', 'warning');
                                return;
                            }

                            const produceAmount = node.rate * template.speed * deltaTime;
                            const actualAmount = Math.min(produceAmount, node.amount);

                            node.amount -= actualAmount;
                            gameState.resources[node.type].current += actualAmount;
                            gameState.resources[node.type].current = Math.min(
                                gameState.resources[node.type].current,
                                gameState.resources[node.type].max
                            );

                            // æ¯ç§’è®°å½•ä¸€æ¬¡
                            if (i % 10 === 0) {
                                log(`  [${(i/10).toFixed(0)}s] ç”Ÿäº§ ${actualAmount.toFixed(2)} ${items.items[node.type].name}ï¼Œå½“å‰: ${gameState.resources[node.type].current.toFixed(2)}`, 'info');
                            }
                        }
                    });
                }

                const finalIronPlate = gameState.resources['iron-plate'].current;
                const produced = finalIronPlate - initialIronPlate;

                log('', 'info');
                log('========================================', 'info');
                log('æµ‹è¯•ç»“æœ:', 'info');
                log(`  åˆå§‹é“æ¿: ${initialIronPlate}`, 'info');
                log(`  æœ€ç»ˆé“æ¿: ${finalIronPlate.toFixed(2)}`, 'info');
                log(`  ç”Ÿäº§æ•°é‡: ${produced.toFixed(2)}`, produced > 0 ? 'success' : 'error');
                log(`  é¢„æœŸç”Ÿäº§: ${(5 * 1.0 * 10).toFixed(2)} (é€Ÿç‡5 Ã— é€Ÿåº¦1.0 Ã— 10ç§’)`, 'info');

                if (produced > 0) {
                    log('', 'success');
                    log('âœ“âœ“âœ“ æµ‹è¯•é€šè¿‡ï¼çŸ¿æœºæ­£å¸¸ç”Ÿäº§èµ„æºï¼', 'success');
                } else {
                    log('', 'error');
                    log('âœ—âœ—âœ— æµ‹è¯•å¤±è´¥ï¼çŸ¿æœºæ²¡æœ‰ç”Ÿäº§èµ„æºï¼', 'error');
                }
                log('========================================', 'info');

            } catch (error) {
                log('', 'error');
                log(`âœ— æµ‹è¯•å‡ºé”™: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
